<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Premailer::Adapter::Nokogumbo
  
    &mdash; &#39;Premailer 1.9.2 Documentation&#39;
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Premailer::Adapter::Nokogumbo";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (N)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Premailer.html" title="Premailer (class)">Premailer</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Adapter.html" title="Premailer::Adapter (module)">Adapter</a></span></span>
     &raquo; 
    <span class="title">Nokogumbo</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Premailer::Adapter::Nokogumbo
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd><span class='object_link'><a href="../../AdapterHelper/RgbToHex.html" title="AdapterHelper::RgbToHex (module)">AdapterHelper::RgbToHex</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/premailer/adapter/nokogumbo.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Nokogiri adapter</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#load_html-instance_method" title="#load_html (instance method)">#<strong>load_html</strong>(input)  &#x21d2; ::Nokogiri::XML </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Load the HTML file and convert it into an Nokogiri document.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_inline_css-instance_method" title="#to_inline_css (instance method)">#<strong>to_inline_css</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Merge CSS into the HTML document.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_plain_text-instance_method" title="#to_plain_text (instance method)">#<strong>to_plain_text</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Converts the HTML document to a format suitable for plain-text e-mail.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_s-instance_method" title="#to_s (instance method)">#<strong>to_s</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Gets the original HTML as a string.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#write_unmergable_css_rules-instance_method" title="#write_unmergable_css_rules (instance method)">#<strong>write_unmergable_css_rules</strong>(doc, unmergable_rules)  &#x21d2; ::Nokogiri::XML </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Create a <tt>style</tt> element with un-mergable rules (e.g. <tt>:hover</tt>) and write it into the <tt>body</tt>.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../../AdapterHelper/RgbToHex.html" title="AdapterHelper::RgbToHex (module)">AdapterHelper::RgbToHex</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../AdapterHelper/RgbToHex.html#ensure_hex-instance_method" title="AdapterHelper::RgbToHex#ensure_hex (method)">#ensure_hex</a></span>, <span class='object_link'><a href="../../AdapterHelper/RgbToHex.html#is_rgb%3F-instance_method" title="AdapterHelper::RgbToHex#is_rgb? (method)">#is_rgb?</a></span>, <span class='object_link'><a href="../../AdapterHelper/RgbToHex.html#to_hex-instance_method" title="AdapterHelper::RgbToHex#to_hex (method)">#to_hex</a></span></p>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="load_html-instance_method">
  
    #<strong>load_html</strong>(input)  &#x21d2; <tt>::Nokogiri::XML</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Load the HTML file and convert it into an Nokogiri document.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>::Nokogiri::XML</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>a document.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/premailer/adapter/nokogumbo.rb', line 199</span>

<span class='kw'>def</span> <span class='id identifier rubyid_load_html'>load_html</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span> <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_thing'>thing</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='comment'># TODO: duplicate options
</span>  <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:with_html_string</span><span class='rbracket'>]</span> <span class='kw'>or</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:inline</span><span class='rbracket'>]</span> <span class='kw'>or</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:read</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_thing'>thing</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>
  <span class='kw'>elsif</span> <span class='ivar'>@is_local_file</span>
    <span class='ivar'>@base_dir</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_thing'>thing</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>r</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_thing'>thing</span> <span class='op'>=</span> <span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_thing'>thing</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:read</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_thing'>thing</span> <span class='op'>=</span> <span class='id identifier rubyid_thing'>thing</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='id identifier rubyid_thing'>thing</span>
  <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='comment'># Handle HTML entities
</span>  <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:replace_html_entities</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>true</span> <span class='kw'>and</span> <span class='id identifier rubyid_thing'>thing</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Premailer.html#HTML_ENTITIES-constant" title="Premailer::HTML_ENTITIES (constant)">HTML_ENTITIES</a></span></span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_entity'>entity</span><span class='comma'>,</span> <span class='id identifier rubyid_replacement'>replacement</span><span class='op'>|</span>
      <span class='id identifier rubyid_thing'>thing</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span> <span class='id identifier rubyid_entity'>entity</span><span class='comma'>,</span> <span class='id identifier rubyid_replacement'>replacement</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'># Default encoding is ASCII-8BIT (binary) per http://groups.google.com/group/nokogiri-talk/msg/0b81ef0dc180dc74
</span>  <span class='comment'># However, we really don&#39;t want to hardcode this. ASCII-8BIT should be the default, but not the only option.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_thing'>thing</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='const'>RUBY_VERSION</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>1.9</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_thing'>thing</span> <span class='op'>=</span> <span class='id identifier rubyid_thing'>thing</span><span class='period'>.</span><span class='id identifier rubyid_force_encoding'>force_encoding</span><span class='lparen'>(</span><span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:input_encoding</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_encode!'>encode!</span>
    <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>Nokogiri</span><span class='op'>::</span><span class='const'>HTML5</span><span class='lparen'>(</span><span class='id identifier rubyid_thing'>thing</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_default_encoding'>default_encoding</span> <span class='op'>=</span> <span class='const'>RUBY_PLATFORM</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>java</span><span class='tstring_end'>&#39;</span></span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BINARY</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>Nokogiri</span><span class='op'>::</span><span class='const'>HTML5</span><span class='lparen'>(</span><span class='id identifier rubyid_thing'>thing</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Fix for removing any CDATA tags from both style and script tags inserted per
</span>  <span class='comment'># https://github.com/sparklemotion/nokogiri/issues/311 and
</span>  <span class='comment'># https://github.com/premailer/premailer/issues/199
</span>  <span class='qwords_beg'>%w(</span><span class='tstring_content'>style</span><span class='words_sep'> </span><span class='tstring_content'>script</span><span class='words_sep'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_tag'>tag</span><span class='op'>|</span>
    <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='id identifier rubyid_tag'>tag</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_children'>children</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_child'>child</span><span class='op'>|</span>
      <span class='id identifier rubyid_child'>child</span><span class='period'>.</span><span class='id identifier rubyid_swap'>swap</span><span class='lparen'>(</span><span class='id identifier rubyid_child'>child</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_child'>child</span><span class='period'>.</span><span class='id identifier rubyid_cdata?'>cdata?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_doc'>doc</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="to_inline_css-instance_method">
  
    #<strong>to_inline_css</strong>  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Merge CSS into the HTML document.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>an HTML.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/premailer/adapter/nokogumbo.rb', line 12</span>

<span class='kw'>def</span> <span class='id identifier rubyid_to_inline_css'>to_inline_css</span>
  <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='ivar'>@processed_doc</span>
  <span class='ivar'>@unmergable_rules</span> <span class='op'>=</span> <span class='const'>CssParser</span><span class='op'>::</span><span class='const'>Parser</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>

  <span class='comment'># Give all styles already in style attributes a specificity of 1000
</span>  <span class='comment'># per http://www.w3.org/TR/CSS21/cascade.html#specificity
</span>  <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*[@style]</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_el'>el</span><span class='op'>|</span>
    <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>style</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>[SPEC=1000[</span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_attributes'>attributes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>style</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>]]</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
  <span class='comment'># Iterate through the rules and merge them into the HTML
</span>  <span class='ivar'>@css_parser</span><span class='period'>.</span><span class='id identifier rubyid_each_selector'>each_selector</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_declaration'>declaration</span><span class='comma'>,</span> <span class='id identifier rubyid_specificity'>specificity</span><span class='comma'>,</span> <span class='id identifier rubyid_media_types'>media_types</span><span class='op'>|</span>
    <span class='comment'># Save un-mergable rules separately
</span>    <span class='id identifier rubyid_selector'>selector</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>:link([\s]*)+</span><span class='regexp_end'>/i</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='backref'>$1</span> <span class='rbrace'>}</span>

    <span class='comment'># Convert element names to lower case
</span>    <span class='id identifier rubyid_selector'>selector</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>([\s]|^)([\w]+)</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='backref'>$1</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='backref'>$2</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span> <span class='rbrace'>}</span>

    <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="../../Premailer.html" title="Premailer (class)">Premailer</a></span></span><span class='period'>.</span><span class='id identifier rubyid_is_media_query?'>is_media_query?</span><span class='lparen'>(</span><span class='id identifier rubyid_media_types'>media_types</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_selector'>selector</span> <span class='op'>=~</span> <span class='const'><span class='object_link'><a href="../../Premailer.html" title="Premailer (class)">Premailer</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Premailer.html#RE_UNMERGABLE_SELECTORS-constant" title="Premailer::RE_UNMERGABLE_SELECTORS (constant)">RE_UNMERGABLE_SELECTORS</a></span></span>
      <span class='ivar'>@unmergable_rules</span><span class='period'>.</span><span class='id identifier rubyid_add_rule_set!'>add_rule_set!</span><span class='lparen'>(</span><span class='const'>CssParser</span><span class='op'>::</span><span class='const'>RuleSet</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_declaration'>declaration</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_media_types'>media_types</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:preserve_styles</span><span class='rbracket'>]</span>
    <span class='kw'>else</span>
      <span class='kw'>begin</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_selector'>selector</span> <span class='op'>=~</span> <span class='const'><span class='object_link'><a href="../../Premailer.html" title="Premailer (class)">Premailer</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Premailer.html#RE_RESET_SELECTORS-constant" title="Premailer::RE_RESET_SELECTORS (constant)">RE_RESET_SELECTORS</a></span></span>
          <span class='comment'># this is in place to preserve the MailChimp CSS reset: http://github.com/mailchimp/Email-Blueprints/
</span>          <span class='comment'># however, this doesn&#39;t mean for testing pur
</span>          <span class='ivar'>@unmergable_rules</span><span class='period'>.</span><span class='id identifier rubyid_add_rule_set!'>add_rule_set!</span><span class='lparen'>(</span><span class='const'>CssParser</span><span class='op'>::</span><span class='const'>RuleSet</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_selector'>selector</span><span class='comma'>,</span> <span class='id identifier rubyid_declaration'>declaration</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='op'>!</span><span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:preserve_reset</span><span class='rbracket'>]</span>
        <span class='kw'>end</span>

        <span class='comment'># Change single ID CSS selectors into xpath so that we can match more
</span>        <span class='comment'># than one element.  Added to work around dodgy generated code.
</span>        <span class='id identifier rubyid_selector'>selector</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A\#([\w_\-]+)\Z</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>*[@id=\1]</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

        <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='id identifier rubyid_selector'>selector</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_el'>el</span><span class='op'>|</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_elem?'>elem?</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>head</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>and</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_parent'>parent</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>head</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
            <span class='comment'># Add a style attribute or append to the existing one
</span>            <span class='id identifier rubyid_block'>block</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[SPEC=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_specificity'>specificity</span><span class='embexpr_end'>}</span><span class='tstring_content'>[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_declaration'>declaration</span><span class='embexpr_end'>}</span><span class='tstring_content'>]]</span><span class='tstring_end'>&quot;</span></span>
            <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>style</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_attributes'>attributes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>style</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>||=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_block'>block</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'>Nokogiri</span><span class='op'>::</span><span class='const'>SyntaxError</span><span class='comma'>,</span> <span class='const'>RuntimeError</span><span class='comma'>,</span> <span class='const'>ArgumentError</span>
        <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CSS syntax error with selector: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_selector'>selector</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:verbose</span><span class='rbracket'>]</span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Remove script tags
</span>  <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:remove_scripts</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>script</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_remove'>remove</span>
  <span class='kw'>end</span>

  <span class='comment'># Read STYLE attributes and perform folding
</span>  <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*[@style]</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_el'>el</span><span class='op'>|</span>
    <span class='id identifier rubyid_style'>style</span> <span class='op'>=</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_attributes'>attributes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>style</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>

    <span class='id identifier rubyid_declarations'>declarations</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_style'>style</span><span class='period'>.</span><span class='id identifier rubyid_scan'>scan</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\[SPEC\=([\d]+)\[(.[^\]\]]*)\]\]</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_declaration'>declaration</span><span class='op'>|</span>
      <span class='id identifier rubyid_rs'>rs</span> <span class='op'>=</span> <span class='const'>CssParser</span><span class='op'>::</span><span class='const'>RuleSet</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_declaration'>declaration</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='id identifier rubyid_declaration'>declaration</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_declarations'>declarations</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_rs'>rs</span>
    <span class='kw'>end</span>

    <span class='comment'># Perform style folding
</span>    <span class='id identifier rubyid_merged'>merged</span> <span class='op'>=</span> <span class='const'>CssParser</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_declarations'>declarations</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_merged'>merged</span><span class='period'>.</span><span class='id identifier rubyid_expand_shorthand!'>expand_shorthand!</span>

    <span class='comment'># Duplicate CSS attributes as HTML attributes
</span>    <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="../../Premailer.html" title="Premailer (class)">Premailer</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Premailer.html#RELATED_ATTRIBUTES-constant" title="Premailer::RELATED_ATTRIBUTES (constant)">RELATED_ATTRIBUTES</a></span></span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:css_to_attributes</span><span class='rbracket'>]</span>
      <span class='const'><span class='object_link'><a href="../../Premailer.html" title="Premailer (class)">Premailer</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Premailer.html#RELATED_ATTRIBUTES-constant" title="Premailer::RELATED_ATTRIBUTES (constant)">RELATED_ATTRIBUTES</a></span></span><span class='lbracket'>[</span><span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_css_att'>css_att</span><span class='comma'>,</span> <span class='id identifier rubyid_html_att'>html_att</span><span class='op'>|</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='id identifier rubyid_html_att'>html_att</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_merged'>merged</span><span class='lbracket'>[</span><span class='id identifier rubyid_css_att'>css_att</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
          <span class='id identifier rubyid_new_html_att'>new_html_att</span> <span class='op'>=</span> <span class='id identifier rubyid_merged'>merged</span><span class='lbracket'>[</span><span class='id identifier rubyid_css_att'>css_att</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>url\([&#39;|&quot;](.*)[&#39;|&quot;]\)</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\1</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>;$|\s*!important</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
          <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='id identifier rubyid_html_att'>html_att</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_css_att'>css_att</span><span class='period'>.</span><span class='id identifier rubyid_end_with?'>end_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>color</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:rgb_to_hex_attributes</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='id identifier rubyid_ensure_hex'>ensure_hex</span><span class='lparen'>(</span><span class='id identifier rubyid_new_html_att'>new_html_att</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_new_html_att'>new_html_att</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_merged'>merged</span><span class='period'>.</span><span class='id identifier rubyid_instance_variable_get'>instance_variable_get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@declarations</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_declarations'>declarations</span><span class='op'>|</span>
          <span class='kw'>unless</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:preserve_style_attribute</span><span class='rbracket'>]</span>
            <span class='id identifier rubyid_declarations'>declarations</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_css_att'>css_att</span><span class='rparen'>)</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='comment'># Collapse multiple rules into one as much as possible.
</span>    <span class='id identifier rubyid_merged'>merged</span><span class='period'>.</span><span class='id identifier rubyid_create_shorthand!'>create_shorthand!</span> <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:create_shorthands</span><span class='rbracket'>]</span>

    <span class='comment'># write the inline STYLE attribute
</span>    <span class='id identifier rubyid_attributes'>attributes</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Premailer.html" title="Premailer (class)">Premailer</a></span></span><span class='period'>.</span><span class='id identifier rubyid_escape_string'>escape_string</span><span class='lparen'>(</span><span class='id identifier rubyid_merged'>merged</span><span class='period'>.</span><span class='id identifier rubyid_declarations_to_s'>declarations_to_s</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:strip</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_attributes'>attributes</span> <span class='op'>=</span> <span class='id identifier rubyid_attributes'>attributes</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_attr'>attr</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_attr'>attr</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='comma'>,</span> <span class='id identifier rubyid_attr'>attr</span><span class='rbracket'>]</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_sort_by'>sort_by</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_pair'>pair</span><span class='op'>|</span> <span class='id identifier rubyid_pair'>pair</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_pair'>pair</span><span class='op'>|</span> <span class='id identifier rubyid_pair'>pair</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_el'>el</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>style</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_attributes'>attributes</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>; </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_doc'>doc</span> <span class='op'>=</span> <span class='id identifier rubyid_write_unmergable_css_rules'>write_unmergable_css_rules</span><span class='lparen'>(</span><span class='id identifier rubyid_doc'>doc</span><span class='comma'>,</span> <span class='ivar'>@unmergable_rules</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:remove_classes</span><span class='rbracket'>]</span> <span class='kw'>or</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:remove_comments</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_traverse'>traverse</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_el'>el</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_comment?'>comment?</span> <span class='kw'>and</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:remove_comments</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_remove'>remove</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_element?'>element?</span>
        <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_remove_attribute'>remove_attribute</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>class</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:remove_classes</span><span class='rbracket'>]</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:remove_ids</span><span class='rbracket'>]</span>
    <span class='comment'># find all anchor&#39;s targets and hash them
</span>    <span class='id identifier rubyid_targets'>targets</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a[@href^=&#39;#&#39;]</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_el'>el</span><span class='op'>|</span>
      <span class='id identifier rubyid_target'>target</span> <span class='op'>=</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_get_attribute'>get_attribute</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>href</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>1</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_targets'>targets</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_target'>target</span>
      <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_set_attribute'>set_attribute</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>href</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>#</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>Digest</span><span class='op'>::</span><span class='const'>MD5</span><span class='period'>.</span><span class='id identifier rubyid_hexdigest'>hexdigest</span><span class='lparen'>(</span><span class='id identifier rubyid_target'>target</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='comment'># hash ids that are links target, delete others
</span>    <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*[@id]</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_el'>el</span><span class='op'>|</span>
      <span class='id identifier rubyid_id'>id</span> <span class='op'>=</span> <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_get_attribute'>get_attribute</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>id</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_targets'>targets</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_set_attribute'>set_attribute</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>id</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>Digest</span><span class='op'>::</span><span class='const'>MD5</span><span class='period'>.</span><span class='id identifier rubyid_hexdigest'>hexdigest</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_remove_attribute'>remove_attribute</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>id</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:reset_contenteditable</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>*[@contenteditable]</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_el'>el</span><span class='op'>|</span>
      <span class='id identifier rubyid_el'>el</span><span class='period'>.</span><span class='id identifier rubyid_remove_attribute'>remove_attribute</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>contenteditable</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@processed_doc</span> <span class='op'>=</span> <span class='id identifier rubyid_doc'>doc</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_is_xhtml?'>is_xhtml?</span>
    <span class='comment'># we don&#39;t want to encode carriage returns
</span>    <span class='ivar'>@processed_doc</span><span class='period'>.</span><span class='id identifier rubyid_to_xhtml'>to_xhtml</span><span class='lparen'>(</span><span class='symbol'>:encoding</span> <span class='op'>=&gt;</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:output_encoding</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>&amp;\#(xD|13);</span><span class='regexp_end'>/i</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\r</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='ivar'>@processed_doc</span><span class='period'>.</span><span class='id identifier rubyid_to_html'>to_html</span><span class='lparen'>(</span><span class='symbol'>:encoding</span> <span class='op'>=&gt;</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:output_encoding</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="to_plain_text-instance_method">
  
    #<strong>to_plain_text</strong>  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Converts the HTML document to a format suitable for plain-text e-mail.</p>

<p>If present, uses the <body> element as its base; otherwise uses the whole document.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>a plain text.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


175
176
177
178
179
180
181
182
183
184</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/premailer/adapter/nokogumbo.rb', line 175</span>

<span class='kw'>def</span> <span class='id identifier rubyid_to_plain_text'>to_plain_text</span>
  <span class='id identifier rubyid_html_src'>html_src</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_html_src'>html_src</span> <span class='op'>=</span> <span class='ivar'>@doc</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>body</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_inner_html'>inner_html</span>
  <span class='kw'>rescue</span><span class='semicolon'>;</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_html_src'>html_src</span> <span class='op'>=</span> <span class='ivar'>@doc</span><span class='period'>.</span><span class='id identifier rubyid_to_html'>to_html</span> <span class='kw'>unless</span> <span class='id identifier rubyid_html_src'>html_src</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='id identifier rubyid_html_src'>html_src</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='id identifier rubyid_convert_to_text'>convert_to_text</span><span class='lparen'>(</span><span class='id identifier rubyid_html_src'>html_src</span><span class='comma'>,</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:line_length</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='ivar'>@html_encoding</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="to_s-instance_method">
  
    #<strong>to_s</strong>  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Gets the original HTML as a string.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>HTML.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


188
189
190
191
192
193
194</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/premailer/adapter/nokogumbo.rb', line 188</span>

<span class='kw'>def</span> <span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_is_xhtml?'>is_xhtml?</span>
    <span class='ivar'>@doc</span><span class='period'>.</span><span class='id identifier rubyid_to_xhtml'>to_xhtml</span><span class='lparen'>(</span><span class='symbol'>:encoding</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='ivar'>@doc</span><span class='period'>.</span><span class='id identifier rubyid_to_html'>to_html</span><span class='lparen'>(</span><span class='symbol'>:encoding</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="write_unmergable_css_rules-instance_method">
  
    #<strong>write_unmergable_css_rules</strong>(doc, unmergable_rules)  &#x21d2; <tt>::Nokogiri::XML</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Create a <tt>style</tt> element with un-mergable rules (e.g. <tt>:hover</tt>)
and write it into the <tt>body</tt>.</p>

<p><tt>doc</tt> is an Nokogiri document and <tt>unmergable_css_rules</tt> is a Css::RuleSet.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>::Nokogiri::XML</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>a document.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/premailer/adapter/nokogumbo.rb', line 151</span>

<span class='kw'>def</span> <span class='id identifier rubyid_write_unmergable_css_rules'>write_unmergable_css_rules</span><span class='lparen'>(</span><span class='id identifier rubyid_doc'>doc</span><span class='comma'>,</span> <span class='id identifier rubyid_unmergable_rules'>unmergable_rules</span><span class='rparen'>)</span> <span class='comment'># :nodoc:
</span>  <span class='id identifier rubyid_styles'>styles</span> <span class='op'>=</span> <span class='id identifier rubyid_unmergable_rules'>unmergable_rules</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_styles'>styles</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_style_tag'>style_tag</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;style type=\&quot;text/css\&quot;&gt;\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_styles'>styles</span><span class='embexpr_end'>}</span><span class='tstring_content'>&lt;/style&gt;</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_search'>search</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>body</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_at_css'>at_css</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>body</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_children'>children</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_at_css'>at_css</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>body</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_children'>children</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_at_css'>at_css</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>body</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_children'>children</span><span class='period'>.</span><span class='id identifier rubyid_before'>before</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Nokogiri</span><span class='op'>::</span><span class='const'>XML</span><span class='period'>.</span><span class='id identifier rubyid_fragment'>fragment</span><span class='lparen'>(</span><span class='id identifier rubyid_style_tag'>style_tag</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_at_css'>at_css</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>body</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_add_child'>add_child</span><span class='lparen'>(</span><span class='op'>::</span><span class='const'>Nokogiri</span><span class='op'>::</span><span class='const'>XML</span><span class='period'>.</span><span class='id identifier rubyid_fragment'>fragment</span><span class='lparen'>(</span><span class='id identifier rubyid_style_tag'>style_tag</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_inner_html'>inner_html</span> <span class='op'>=</span> <span class='id identifier rubyid_style_tag'>style_tag</span> <span class='op'>+=</span> <span class='id identifier rubyid_doc'>doc</span><span class='period'>.</span><span class='id identifier rubyid_inner_html'>inner_html</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_doc'>doc</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Feb  3 11:30:28 2017 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.8 (ruby-2.4.0).
</div>

    </div>
  </body>
</html>